cmake_minimum_required(VERSION 3.18)

project("LiQuiBit")

if(CMAKE_CURRENT_BINARY_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
  set(CMAKE_CURRENT_BINARY_DIR "${CMAKE_CURRENT_BINARY_DIR}/build")
  MESSAGE("setting build location ${CMAKE_CURRENT_BINARY_DIR} vs ${CMAKE_CURRENT_SOURCE_DIR}")
else()
  MESSAGE("not setting build location ${CMAKE_CURRENT_BINARY_DIR} vs ${CMAKE_CURRENT_SOURCE_DIR}")
endif()

if(CMAKE_EXTRA_GENERATOR)
    set (GENERATOR "${CMAKE_EXTRA_GENERATOR} - ${CMAKE_GENERATOR}")
else()
    set (GENERATOR "${CMAKE_GENERATOR}")
endif(CMAKE_EXTRA_GENERATOR)

set(SUB_IOT_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/Sub-IoT-Stack/stack")

set(EDGE_OPTIONS
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
)

set(HARDWARE_VERSIONS "PUSH7" "PUSH7_V3")

foreach(HARDWARE_VERSION IN LISTS HARDWARE_VERSIONS)

    set(BUILD_PUSH7_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/${HARDWARE_VERSION}-release")
    execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_PUSH7_RELEASE})
    execute_process(
        WORKING_DIRECTORY ${BUILD_PUSH7_RELEASE}
        COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
        -D PLATFORM=${HARDWARE_VERSION}
        -D APP_PUSH7_BUTTON=y
        ${EDGE_OPTIONS}
        -D FRAMEWORK_DEBUG_ENABLE_SWD=n
        -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
        -D CMAKE_BUILD_TYPE=Debug
        ${SUB_IOT_SOURCE}
    )

    add_custom_target(${HARDWARE_VERSION}-release ALL
        WORKING_DIRECTORY ${BUILD_PUSH7_RELEASE}
        COMMAND ${CMAKE_MAKE_PROGRAM} -j push7_button.elf
    )

    set(BUILD_PUSH7_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/${HARDWARE_VERSION}-debug")
    execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_PUSH7_DEBUG})
    execute_process(
        WORKING_DIRECTORY ${BUILD_PUSH7_DEBUG}
        COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
        -D PLATFORM=${HARDWARE_VERSION}
        -D APP_PUSH7_BUTTON=y
        ${EDGE_OPTIONS}
        -D FRAMEWORK_DEBUG_ENABLE_SWD=n
        -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
        -D FRAMEWORK_LOG_OUTPUT_ON_RTT=n
        -D FRAMEWORK_CONSOLE_ENABLED=y
        -D PLATFORM_CONSOLE_UART=0
        -D CMAKE_BUILD_TYPE=Debug
        ${SUB_IOT_SOURCE}
    )

    add_custom_target(${HARDWARE_VERSION}-debug ALL
        WORKING_DIRECTORY ${BUILD_PUSH7_DEBUG}
        COMMAND ${CMAKE_MAKE_PROGRAM} -j push7_button.elf
    )

    set(BUILD_PUSH7_DEBUG_RTT "${CMAKE_CURRENT_BINARY_DIR}/${HARDWARE_VERSION}-rtt-debug")
    execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_PUSH7_DEBUG_RTT})
    execute_process(
        WORKING_DIRECTORY ${BUILD_PUSH7_DEBUG_RTT}
        COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
        -D PLATFORM=${HARDWARE_VERSION}
        -D APP_PUSH7_BUTTON=y
        ${EDGE_OPTIONS}
        -D FRAMEWORK_DEBUG_ENABLE_SWD=y
        -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
        -D FRAMEWORK_LOG_OUTPUT_ON_RTT=y
        -D CMAKE_BUILD_TYPE=Debug
        ${SUB_IOT_SOURCE}
    )

    add_custom_target(${HARDWARE_VERSION}-rtt-debug ALL
        WORKING_DIRECTORY ${BUILD_PUSH7_DEBUG_RTT}
        COMMAND ${CMAKE_MAKE_PROGRAM} -j push7_button.elf
    )

endforeach()

set(IOWAY_OPTIONS
    -D PLATFORM=IOWAY_gateway
    -D APP_GATEWAY=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=y
    -D FRAMEWORK_SCHEDULER_LP_MODE=0
)

set(BUILD_IOWAY_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/IOWay-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    ${IOWAY_OPTIONS}
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway-release ALL
    WORKING_DIRECTORY ${BUILD_IOWAY_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)

set(BUILD_IOWAY_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/IOWay-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY_DEBUG})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY_DEBUG}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    ${IOWAY_OPTIONS}
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=n
    -D FRAMEWORK_CONSOLE_ENABLED=y
    -D PLATFORM_MODEM_INTERFACE_UART=0
    -D PLATFORM_CONSOLE_UART=1
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway-debug ALL
    WORKING_DIRECTORY ${BUILD_IOWAY_DEBUG}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)

set(BUILD_IOWAY_DEBUG_RTT "${CMAKE_CURRENT_BINARY_DIR}/IOWay-rtt-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY_DEBUG_RTT})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY_DEBUG_RTT}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    ${IOWAY_OPTIONS}
    -D FRAMEWORK_DEBUG_ENABLE_SWD=y
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway-rtt-debug ALL
    WORKING_DIRECTORY ${BUILD_IOWAY_DEBUG_RTT}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)


set(BUILD_LINK7_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/Link7-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_LINK7_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_LINK7_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=LINK7_V1
    -D APP_LINK7_BASIC=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(link7-release ALL
    WORKING_DIRECTORY ${BUILD_LINK7_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j link7_basic.elf
)

set(BUILD_LINK7_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/Link7-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_LINK7_DEBUG})
execute_process(
    WORKING_DIRECTORY ${BUILD_LINK7_DEBUG}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=LINK7_V1
    -D APP_LINK7_BASIC=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=y
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=y
    -D FRAMEWORK_CONSOLE_ENABLED=n
    -D PLATFORM_CONSOLE_UART=0
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(link7-debug ALL
    WORKING_DIRECTORY ${BUILD_LINK7_DEBUG}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j link7_basic.elf
)

set(BUILD_LINK7_GATEWAY "${CMAKE_CURRENT_BINARY_DIR}/Link7-gateway")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_LINK7_GATEWAY})
execute_process(
    WORKING_DIRECTORY ${BUILD_LINK7_GATEWAY}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=LINK7_V1
    -D APP_GATEWAY=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=y
    -D FRAMEWORK_SCHEDULER_LP_MODE=255
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=y
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=y
    -D FRAMEWORK_CONSOLE_ENABLED=n
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(link7-gateway ALL
    WORKING_DIRECTORY ${BUILD_LINK7_GATEWAY}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)

set(BUILD_SENSE7_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/Sense7-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_SENSE7_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_SENSE7_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=SENSE7_V1
    -D APP_SENSE7_BASIC=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(sense7-release ALL
    WORKING_DIRECTORY ${BUILD_SENSE7_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j sense7_basic.elf
)

set(BUILD_SENSE7_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/Sense7-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_SENSE7_DEBUG})
execute_process(
    WORKING_DIRECTORY ${BUILD_SENSE7_DEBUG}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=SENSE7_V1
    -D APP_SENSE7_BASIC=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=y
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=y
    -D FRAMEWORK_CONSOLE_ENABLED=n
    -D PLATFORM_CONSOLE_UART=0
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(sense7-debug ALL
    WORKING_DIRECTORY ${BUILD_SENSE7_DEBUG}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j sense7_basic.elf
)