cmake_minimum_required(VERSION 3.18)

project("LiQuiBit")

if(CMAKE_CURRENT_BINARY_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
  set(CMAKE_CURRENT_BINARY_DIR "${CMAKE_CURRENT_BINARY_DIR}/build")
endif()

if(CMAKE_EXTRA_GENERATOR)
    set (GENERATOR "${CMAKE_EXTRA_GENERATOR} - ${CMAKE_GENERATOR}")
else()
    set (GENERATOR "${CMAKE_GENERATOR}")
endif(CMAKE_EXTRA_GENERATOR)

set(SUB_IOT_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/Sub-IoT-Stack/stack")

set(BUILD_PUSH7 "${CMAKE_CURRENT_BINARY_DIR}/Push7")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_PUSH7})
execute_process(
    WORKING_DIRECTORY ${BUILD_PUSH7}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=PUSH7
    -D APP_PUSH7_BUTTON=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(push7 ALL
    WORKING_DIRECTORY ${BUILD_PUSH7}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j push7_button.elf
)

set(BUILD_IOWAY "${CMAKE_CURRENT_BINARY_DIR}/IOWay")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=IOWAY_gateway
    -D APP_GATEWAY=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=y
    -D FRAMEWORK_SCHEDULER_LP_MODE=0
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway ALL
    WORKING_DIRECTORY ${BUILD_IOWAY}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)
