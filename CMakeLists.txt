cmake_minimum_required(VERSION 3.18)

project("LiQuiBit")

if(CMAKE_CURRENT_BINARY_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
  set(CMAKE_CURRENT_BINARY_DIR "${CMAKE_CURRENT_BINARY_DIR}/build")
endif()

if(CMAKE_EXTRA_GENERATOR)
    set (GENERATOR "${CMAKE_EXTRA_GENERATOR} - ${CMAKE_GENERATOR}")
else()
    set (GENERATOR "${CMAKE_GENERATOR}")
endif(CMAKE_EXTRA_GENERATOR)

set(SUB_IOT_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/Sub-IoT-Stack/stack")

set(BUILD_PUSH7_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/Push7-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_PUSH7_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_PUSH7_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=PUSH7
    -D APP_PUSH7_BUTTON=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(push7-release ALL
    WORKING_DIRECTORY ${BUILD_PUSH7_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j push7_button.elf
)

set(BUILD_PUSH7_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/Push7-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_PUSH7_DEBUG})
execute_process(
    WORKING_DIRECTORY ${BUILD_PUSH7_DEBUG}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=PUSH7
    -D APP_PUSH7_BUTTON=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=n
    -D FRAMEWORK_CONSOLE_ENABLED=y
    -D PLATFORM_CONSOLE_UART=0
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(push7-debug ALL
    WORKING_DIRECTORY ${BUILD_PUSH7_DEBUG}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j push7_button.elf
)

set(BUILD_IOWAY_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/IOWay-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=IOWAY_gateway
    -D APP_GATEWAY=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=y
    -D FRAMEWORK_SCHEDULER_LP_MODE=0
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway-release ALL
    WORKING_DIRECTORY ${BUILD_IOWAY_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)

set(BUILD_IOWAY_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/IOWay-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_IOWAY_DEBUG})
execute_process(
    WORKING_DIRECTORY ${BUILD_IOWAY_DEBUG}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=IOWAY_gateway
    -D APP_GATEWAY=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=y
    -D FRAMEWORK_SCHEDULER_LP_MODE=0
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=n
    -D FRAMEWORK_CONSOLE_ENABLED=y
    -D PLATFORM_MODEM_INTERFACE_UART=0
    -D PLATFORM_CONSOLE_UART=1
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(ioway-debug ALL
    WORKING_DIRECTORY ${BUILD_IOWAY_DEBUG}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j gateway.elf
)


set(BUILD_MODBUS_FORWARDER_RELEASE "${CMAKE_CURRENT_BINARY_DIR}/modbus_forwarder-release")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_MODBUS_FORWARDER_RELEASE})
execute_process(
    WORKING_DIRECTORY ${BUILD_MODBUS_FORWARDER_RELEASE}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=MODBUS_TO_D7
    -D APP_MODBUS_FORWARDER=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=1
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=n
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=y
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(modbus_forwarder-release ALL
    WORKING_DIRECTORY ${BUILD_MODBUS_FORWARDER_RELEASE}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j modbus_forwarder.elf
)

set(BUILD_MODBUS_FORWARDER_DEBUG "${CMAKE_CURRENT_BINARY_DIR}/modbus_forwarder-debug")
execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${BUILD_MODBUS_FORWARDER_DEBUG})
execute_process(
    WORKING_DIRECTORY ${BUILD_MODBUS_FORWARDER_DEBUG}
    COMMAND ${CMAKE_COMMAND} -G "${GENERATOR}"
    -D PLATFORM=MODBUS_TO_D7
    -D APP_MODBUS_FORWARDER=y
    -D MODULE_ALP_SERIAL_INTERFACE_ENABLED=n
    -D FRAMEWORK_SCHEDULER_LP_MODE=255
    -D FRAMEWORK_FS_FILE_COUNT=80
    -D FRAMEWORK_FS_PERMANENT_STORAGE_SIZE=2800
    -D FRAMEWORK_FS_VOLATILE_STORAGE_SIZE=154
    -D FRAMEWORK_DEBUG_ENABLE_SWD=y
    -D FRAMEWORK_FS_USER_FILE_COUNT=11
    -D FRAMEWORK_SCHEDULER_MAX_TASKS=60
    -D FRAMEWORK_DEBUG_ASSERT_REBOOT=n
    -D FRAMEWORK_LOG_OUTPUT_ON_RTT=y
    -D FRAMEWORK_CONSOLE_ENABLED=n
    -D CMAKE_BUILD_TYPE=Debug
    ${SUB_IOT_SOURCE}
)

add_custom_target(modbus_forwarder-debug ALL
    WORKING_DIRECTORY ${BUILD_MODBUS_FORWARDER_DEBUG}
    COMMAND ${CMAKE_MAKE_PROGRAM} -j modbus_forwarder.elf
)